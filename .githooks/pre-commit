#!/bin/bash

# ã‚¹ãƒ†ãƒ¼ã‚¸æ¸ˆã¿ã®Swiftãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—(æ”¹è¡Œæ–‡å­—åŒºåˆ‡ã‚Š)
stagedSwiftFiles=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.swift$')
# ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã«ã‚ˆã‚Šå¤‰æ›´ãŒã‚ã£ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
is_changed=0
# ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã«ã‚ˆã‚Šå¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
changed_files=()

if xcrun --find swift-format >/dev/null && [ -n "$stagedSwiftFiles" ]; then
  # å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ï¼‘ä»¶ãšã¤ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã—å·®åˆ†ã‚’æ¯”è¼ƒã™ã‚‹
  # åŒãƒ•ã‚¡ã‚¤ãƒ«ã«æœªã‚¹ãƒ†ãƒ¼ã‚¸ã®è¡Œã¨ã‚¹ãƒ†ãƒ¼ã‚¸æ¸ˆã¿ã®è¡ŒãŒã‚ã‚‹å ´åˆã«å¤‰æ›´ãªã—ã¨ã™ã‚‹ãŸã‚
  while IFS= read -r file; do
    # æ¯”è¼ƒç”¨ã«ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    tmp="$(mktemp "${file##*/}".XXXXXX.swift)"
    cp -- "$file" "$tmp"
    xcrun swift-format format --in-place "$file"
    # å·®åˆ†ãƒã‚§ãƒƒã‚¯
    if ! diff -q -- "$file" "$tmp" >/dev/null; then
      is_changed=1
      changed_files+=("$file")
    fi
    rm -f -- "$tmp"
  done < <(printf '%s\n' "$stagedSwiftFiles")
else
  echo "âš ï¸ swift-format ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
  exit 0
fi

if [ "$is_changed" -eq 1 ]; then
  echo ""
  echo "âœ¨ swift-format ã«ã‚ˆã‚Šãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿®æ­£ã•ã‚Œã¾ã—ãŸã€‚"
  echo "å¤‰æ›´ã‚’ç¢ºèªã—ã€ã‚‚ã†ä¸€åº¦ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"
  echo ""
  echo "ðŸ” ä¿®æ­£ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
  git diff --stat -- "${changed_files[@]}"
  exit 1
fi


